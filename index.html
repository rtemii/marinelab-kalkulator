<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>MarineLab - Kalkulator (Netto) + Live DB</title>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body { 
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
      background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
      min-height: 100vh; 
      padding: 20px; 
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .container { 
      width: 100%;
      max-width: 1200px; /* Increased for monitors */
      background: white; 
      border-radius: 20px; 
      box-shadow: 0 20px 50px rgba(0,0,0,0.2);
      overflow: hidden;
      display: flex;
      flex-direction: column;
    }
    
    /* Header Styles */
    .header {
      background: linear-gradient(135deg, #4472C4 0%, #365A99 100%);
      color: white; 
      padding: 20px; 
      text-align: center;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .header h1 { font-size: 24px; margin: 0; }
    .status-badge { font-size: 12px; background: rgba(255,255,255,0.2); padding: 4px 10px; border-radius: 15px; }

    /* Layout for Monitor (Desktop) */
    .main-content {
      display: flex;
      flex-wrap: wrap;
    }
    .panel-left {
      flex: 1;
      min-width: 350px;
      padding: 30px;
      border-right: 1px solid #eee;
    }
    .panel-right {
      flex: 1.5;
      min-width: 350px;
      padding: 30px;
      background: #fcfcfc;
      display: flex;
      flex-direction: column;
    }

    /* Form Elements */
    .form-group { margin-bottom: 20px; }
    .form-row { display: flex; gap: 15px; margin-bottom: 15px; }
    .form-row > div { flex: 1; }
    
    label { display: block; margin-bottom: 8px; font-weight: 600; color: #333; font-size: 13px; text-transform: uppercase; letter-spacing: 0.5px; }
    select, input { 
      width: 100%; padding: 12px 15px; 
      border: 2px solid #e1e5e9; border-radius: 8px; 
      font-size: 15px; transition: all 0.3s ease;
    }
    select:focus, input:focus { outline: none; border-color: #4472C4; box-shadow: 0 0 0 3px rgba(68,114,196,0.1); }

    /* Service Grid (Right Panel) */
    .service-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
      gap: 10px;
      max-height: 400px;
      overflow-y: auto;
      padding: 5px;
    }
    .service-item {
      padding: 15px 10px;
      border: 2px solid #eef2f7;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.2s;
      background: white;
      font-size: 13px;
      text-align: center;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      height: 80px;
    }
    .service-item:hover { border-color: #4472C4; transform: translateY(-2px); box-shadow: 0 4px 10px rgba(0,0,0,0.05); }
    .service-item.selected { background: #4472C4; color: white; border-color: #365A99; }
    
    /* Selected List */
    .services-list {
      display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 20px;
      min-height: 40px; padding: 10px; background: #f8f9fa; border-radius: 8px; border: 1px dashed #cbd5e0;
    }
    .service-tag {
      background: #fff; border: 1px solid #4472C4; color: #4472C4;
      padding: 4px 10px; border-radius: 15px; font-size: 12px; font-weight: 600;
      display: flex; align-items: center; gap: 5px;
    }
    .service-tag span { cursor: pointer; font-weight: bold; color: #dc3545; }

    /* Results & Footer */
    .results-card {
      background: white;
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 5px 15px rgba(0,0,0,0.05);
      margin-top: auto; /* Pushes to bottom */
    }
    .result-row { display: flex; justify-content: space-between; margin-bottom: 8px; font-size: 14px; color: #555; }
    .total-profit { 
      font-size: 22px; font-weight: bold; color: #28a745; 
      text-align: center; margin-top: 15px; padding-top: 15px; border-top: 2px solid #eee; 
    }
    
    /* Buttons */
    .btn-group { display: flex; gap: 10px; margin-top: 20px; }
    .btn { flex: 1; padding: 12px; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; transition: 0.2s; }
    .btn:disabled { opacity: 0.6; cursor: not-allowed; }
    .btn-primary { background: #4472C4; color: white; }
    .btn-primary:hover { background: #365A99; }
    .btn-outline { background: transparent; border: 2px solid #ddd; color: #666; }
    .btn-outline:hover { border-color: #aaa; }

    .loading-overlay {
      position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(255,255,255,0.9); display: flex; justify-content: center; align-items: center;
      z-index: 1000; font-weight: bold; color: #4472C4;
    }

    /* Mobile Responsiveness */
    @media (max-width: 768px) {
      .container { flex-direction: column; max-height: none; border-radius: 0; }
      body { padding: 0; }
      .main-content { flex-direction: column; }
      .panel-left, .panel-right { padding: 20px; border: none; }
      .service-grid { max-height: 200px; }
    }
  </style>
</head>
<body>

  <!-- Loader -->
  <div id="loader" class="loading-overlay" style="display:none;">üîÑ Pobieranie bazy danych...</div>

  <div class="container">
    <div class="header">
      <h1>üõ†Ô∏è MarineLab Pro <small style="font-size:0.6em; opacity:0.8">v2.0</small></h1>
      <div class="status-badge" id="dbStatus">üì¶ Baza: Domy≈õlna</div>
    </div>

    <div class="main-content">
      <!-- LEFT PANEL: Inputs -->
      <div class="panel-left">
        <div class="form-group">
          <label>üìÖ Data projektu</label>
          <input type="month" id="projectDate">
        </div>

        <div class="form-group">
          <label>üìã Nazwa faktury / Zlecenie</label>
          <input type="text" id="invoiceName" placeholder="Wpisz nazwƒô...">
        </div>

        <div class="form-group">
          <label>üë∑ Mechanik</label>
          <select id="mechanic" onchange="loadServices()">
            <option value="">-- Wybierz --</option>
            <!-- Options loaded via JS -->
          </select>
        </div>

        <div class="form-row">
          <div>
            <label>üí∞ Faktura (Netto)</label>
            <input type="number" id="invoiceAmount" placeholder="0.00" oninput="updateResults()">
          </div>
          <div>
            <label>‚öôÔ∏è Koszt Czƒô≈õci (Netto)</label>
            <input type="number" id="partsCost" placeholder="0.00" oninput="updateResults()">
          </div>
        </div>

        <div class="btn-group">
          <button class="btn btn-primary" id="sendBtn" onclick="sendToMake()" disabled>üöÄ Wy≈õlij</button>
          <button class="btn btn-outline" onclick="clearAll()">üóëÔ∏è Reset</button>
        </div>
        <p id="msg" style="text-align:center; margin-top:10px; font-size:12px; height:15px;"></p>
      </div>

      <!-- RIGHT PANEL: Services & Logic -->
      <div class="panel-right">
        <label>üîß Wybierz wykonane us≈Çugi:</label>
        <div id="servicesGrid" class="service-grid">
          <div style="grid-column: 1/-1; text-align:center; color:#999; padding: 40px;">
            Najpierw wybierz mechanika üëà
          </div>
        </div>

        <label style="margin-top:20px;">Wybrane:</label>
        <div id="servicesList" class="services-list"></div>

        <div class="results-card">
          <div class="result-row">
            <span>Robocizna (Koszt):</span> <strong id="laborCost">0.00 z≈Ç</strong>
          </div>
          <div class="result-row">
            <span>Czƒô≈õci:</span> <strong id="partsCostDisplay">0.00 z≈Ç</strong>
          </div>
          <div class="result-row">
            <span>Przych√≥d (Netto):</span> <strong id="invoiceTotalDisplay">0.00 z≈Ç</strong>
          </div>
          <div class="total-profit" id="companyProfit">
            Zysk: 0.00 z≈Ç
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>

    const SEND_WEBHOOK_URL = 'https://hook.eu2.make.com/s3zw427rmr92hlo9sb4s9s8g4d6fsa42';
    const DB_WEBHOOK_URL = 'https://hook.eu2.make.com/as0emqranzdjwst67bvy37101wv5gp1s'; 

    // Default fallback database
    const DEFAULT_PRICES = {
      "Marek": { "Roboczogodzina": 300, "1-cyl przeglƒÖd": 210, "2-cyl przeglƒÖd": 320, "4-cyl przeglƒÖd": 900, "Ma≈Çy monta≈º": 1500, "Du≈ºy monta≈º": 2500 },
      "Waldek": { "1 godzina": 100, "2 godziny": 200, "PrzeglƒÖd": 250 },
      "Jarek": { "1 godzina": 100, "2 godziny": 200 },
      "Jacek": { "1 godzina": 100, "2 godziny": 200 },
      "Roman": {}
    };

    let pricesDB = DEFAULT_PRICES;
    let selectedServices = [];

    // --- INITIALIZATION ---
    window.onload = async function() {
      // Set default date to current month
      const dateInput = document.getElementById('projectDate');
      const now = new Date();
      const month = (now.getMonth() + 1).toString().padStart(2, '0');
      dateInput.value = `${now.getFullYear()}-${month}`;

      // Try to fetch dynamic prices
      await fetchPrices();
      
      // Populate Mechanics Dropdown
      populateMechanics();
    };

    // --- DATABASE LOGIC ---
        // --- DATABASE LOGIC ---
    async function fetchPrices() {
      if (!DB_WEBHOOK_URL) return; // Use defaults

      document.getElementById('loader').style.display = 'flex';
      try {
        const response = await fetch(DB_WEBHOOK_URL);
        if (response.ok) {
          const rawData = await response.json();
          
          // NEW LOGIC: Convert "Flat List" (Excel style) to "Grouped Object" (App style)
          // Expected input: [{"Technik": "Marek", "Service": "Roboczogodzina", "Price_Net": 300}, ...]
          
          let newPricesDB = {};

          if (Array.isArray(rawData)) {
            rawData.forEach(row => {
              // Adjust these keys if your Make.com output uses different names (e.g. "A", "B", "C")
              // We try to be flexible here:
              let mechName = row["Technik"] || row["A"] || row[0];
              let svcName = row["Service"] || row["B"] || row[1];
              let price = row["Price_Net"] || row["C"] || row[2];

              if (mechName && svcName) {
                if (!newPricesDB[mechName]) {
                  newPricesDB[mechName] = {};
                }
                newPricesDB[mechName][svcName] = Number(price);
              }
            });
          }

          // Only update if we found valid data
          if (Object.keys(newPricesDB).length > 0) {
            pricesDB = newPricesDB;
            document.getElementById('dbStatus').textContent = 'üü¢ Baza: Excel (Live)';
            document.getElementById('dbStatus').style.background = '#d4edda';
            document.getElementById('dbStatus').style.color = '#155724';
          }
        }
      } catch (e) {
        console.error("Failed to fetch DB, using default", e);
        document.getElementById('dbStatus').textContent = '‚ö†Ô∏è Baza: Offline';
      } finally {
        document.getElementById('loader').style.display = 'none';
        // Refresh dropdown with new names
        populateMechanics();
      }
    }


    function populateMechanics() {
      const select = document.getElementById('mechanic');
      select.innerHTML = '<option value="">-- Wybierz --</option>';
      Object.keys(pricesDB).forEach(mech => {
        let opt = document.createElement('option');
        opt.value = mech;
        opt.textContent = mech;
        select.appendChild(opt);
      });
    }

    // --- UI LOGIC ---
    function loadServices() {
      let mechanic = document.getElementById('mechanic').value;
      let grid = document.getElementById('servicesGrid');
      
      selectedServices = [];
      updateResults();
      
      if (!mechanic) {
        grid.innerHTML = '<div style="grid-column: 1/-1; text-align:center; color:#999; padding: 40px;">Najpierw wybierz mechanika üëà</div>';
        return;
      }

      const services = pricesDB[mechanic] || {};
      const keys = Object.keys(services);

      if (keys.length === 0) {
        grid.innerHTML = '<div style="grid-column: 1/-1; text-align:center; padding: 20px;">Brak cennika dla tego mechanika (lub wpisz manualnie)</div>';
        return;
      }

      grid.innerHTML = keys.map(svc => `
        <div class="service-item" onclick="toggleService('${svc}')">
          <strong>${svc}</strong>
          <small style="color:#666; margin-top:5px;">${services[svc]} z≈Ç</small>
        </div>
      `).join('');
    }

    function toggleService(serviceName) {
      let mechanic = document.getElementById('mechanic').value;
      let cost = pricesDB[mechanic][serviceName];
      
      selectedServices.push({ name: serviceName, cost: cost });
      renderSelectedList();
      updateResults();
    }

    function renderSelectedList() {
      const list = document.getElementById('servicesList');
      list.innerHTML = selectedServices.map((item, index) => `
        <div class="service-tag">
          ${item.name} 
          <span onclick="removeService(${index})">√ó</span>
        </div>
      `).join('');
    }

    function removeService(index) {
      selectedServices.splice(index, 1);
      renderSelectedList();
      updateResults();
    }

    function updateResults() {
      let invoiceAmount = parseFloat(document.getElementById('invoiceAmount').value) || 0;
      let partsCost = parseFloat(document.getElementById('partsCost').value) || 0;
      
      // Calculate Labor
      let laborCost = selectedServices.reduce((sum, item) => sum + item.cost, 0);
      
      // Calculate Profit (All Netto)
      let profit = invoiceAmount - partsCost - laborCost;

      // Display
      document.getElementById('laborCost').textContent = laborCost.toFixed(2) + ' z≈Ç';
      document.getElementById('partsCostDisplay').textContent = partsCost.toFixed(2) + ' z≈Ç';
      document.getElementById('invoiceTotalDisplay').textContent = invoiceAmount.toFixed(2) + ' z≈Ç';
      
      const profitEl = document.getElementById('companyProfit');
      profitEl.textContent = 'Zysk: ' + profit.toFixed(2) + ' z≈Ç';
      profitEl.style.color = profit >= 0 ? '#28a745' : '#dc3545';

      // Validate Send Button
      const isValid = document.getElementById('projectDate').value && 
                      document.getElementById('invoiceName').value && 
                      document.getElementById('mechanic').value;
      document.getElementById('sendBtn').disabled = !isValid;
    }

    async function sendToMake() {
      const btn = document.getElementById('sendBtn');
      const msg = document.getElementById('msg');
      
      btn.disabled = true;
      btn.textContent = '‚è≥ Wysy≈Çanie...';

      // Prepare Payload
      let invoiceAmount = parseFloat(document.getElementById('invoiceAmount').value) || 0;
      let partsCost = parseFloat(document.getElementById('partsCost').value) || 0;
      let laborCost = selectedServices.reduce((sum, item) => sum + item.cost, 0);

      const payload = {
        project_date: document.getElementById('projectDate').value,
        invoice_name: document.getElementById('invoiceName').value,
        mechanik: document.getElementById('mechanic').value,
        uslugi: selectedServices.map(s => s.name).join(', '),
        faktura_netto: invoiceAmount,
        czesci_netto: partsCost,
        robocizna_netto: laborCost,
        zysk_firmy: invoiceAmount - partsCost - laborCost,
        timestamp: new Date().toISOString()
      };

      try {
        let res = await fetch(SEND_WEBHOOK_URL, {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify(payload)
        });
        
        if (res.ok) {
          msg.textContent = '‚úÖ Wys≈Çano pomy≈õlnie!';
          msg.style.color = 'green';
          setTimeout(clearAll, 1500);
        } else {
          throw new Error('B≈ÇƒÖd serwera');
        }
      } catch (e) {
        msg.textContent = '‚ùå B≈ÇƒÖd wysy≈Çania: ' + e.message;
        msg.style.color = 'red';
        btn.disabled = false;
        btn.textContent = 'üöÄ Wy≈õlij';
      }
    }

    function clearAll() {
      document.getElementById('invoiceName').value = '';
      document.getElementById('invoiceAmount').value = '';
      document.getElementById('partsCost').value = '';
      document.getElementById('mechanic').value = '';
      document.getElementById('msg').textContent = '';
      document.getElementById('sendBtn').textContent = 'üöÄ Wy≈õlij';
      
      selectedServices = [];
      loadServices(); // Clears grid
      renderSelectedList();
    }
  </script>
</body>
</html>
