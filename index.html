<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>MarineLab Pro v2.3</title>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body { 
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
      background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
      min-height: 100vh; 
      padding: 20px; 
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .container { 
      width: 100%;
      max-width: 1200px;
      background: white; 
      border-radius: 20px; 
      box-shadow: 0 20px 50px rgba(0,0,0,0.2);
      overflow: hidden;
      display: flex;
      flex-direction: column;
    }
    
    /* Header Styles */
    .header {
      background: linear-gradient(135deg, #4472C4 0%, #365A99 100%);
      color: white; 
      padding: 20px; 
      text-align: center;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .header h1 { font-size: 24px; margin: 0; }
    .status-badge { font-size: 12px; background: rgba(255,255,255,0.2); padding: 4px 10px; border-radius: 15px; }

    /* Layout */
    .main-content {
      display: flex;
      flex-wrap: wrap;
    }
    .panel-left {
      flex: 1;
      min-width: 350px;
      padding: 30px;
      border-right: 1px solid #eee;
    }
    .panel-right {
      flex: 1.5;
      min-width: 350px;
      padding: 30px;
      background: #fcfcfc;
      display: flex;
      flex-direction: column;
    }

    /* Form Elements */
    .form-group { margin-bottom: 20px; }
    .form-row { display: flex; gap: 15px; margin-bottom: 15px; }
    .form-row > div { flex: 1; }
    
    label { display: block; margin-bottom: 8px; font-weight: 600; color: #333; font-size: 13px; text-transform: uppercase; letter-spacing: 0.5px; }
    select, input { 
      width: 100%; padding: 12px 15px; 
      border: 2px solid #e1e5e9; border-radius: 8px; 
      font-size: 15px; transition: all 0.3s ease;
    }
    select:focus, input:focus { outline: none; border-color: #4472C4; box-shadow: 0 0 0 3px rgba(68,114,196,0.1); }

    /* Service Grid */
    .service-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
      gap: 10px;
      max-height: 350px;
      overflow-y: auto;
      padding: 5px;
    }
    .service-item {
      padding: 10px;
      border: 2px solid #eef2f7;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.2s;
      background: white;
      font-size: 13px;
      text-align: center;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      min-height: 70px;
    }
    .service-item:hover { border-color: #4472C4; transform: translateY(-2px); box-shadow: 0 4px 10px rgba(0,0,0,0.05); }
    .service-item.selected { background: #4472C4; color: white; border-color: #365A99; }
    
    /* Manual Service Input */
    .manual-service-box {
      background: #e3f2fd;
      padding: 15px;
      border-radius: 8px;
      margin-top: 15px;
      border: 1px solid #bbdefb;
    }
    .manual-row { display: flex; gap: 10px; align-items: flex-end; }
    .manual-btn { background: #1976d2; color: white; border: none; padding: 10px 15px; border-radius: 6px; cursor: pointer; font-weight: bold;}

    /* Selected List */
    .services-list {
      display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 20px;
      min-height: 40px; padding: 10px; background: #f8f9fa; border-radius: 8px; border: 1px dashed #cbd5e0;
      margin-top: 15px;
    }
    .service-tag {
      background: #fff; border: 1px solid #4472C4; color: #4472C4;
      padding: 4px 10px; border-radius: 15px; font-size: 12px; font-weight: 600;
      display: flex; align-items: center; gap: 5px;
    }
    .service-tag span { cursor: pointer; font-weight: bold; color: #dc3545; }

    /* Results */
    .results-card {
      background: white;
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 5px 15px rgba(0,0,0,0.05);
      margin-top: auto; 
    }
    .result-row { display: flex; justify-content: space-between; margin-bottom: 8px; font-size: 14px; color: #555; }
    .total-profit { 
      font-size: 22px; font-weight: bold; color: #28a745; 
      text-align: center; margin-top: 15px; padding-top: 15px; border-top: 2px solid #eee; 
    }
    
    /* Buttons */
    .btn-group { display: flex; gap: 10px; margin-top: 20px; }
    .btn { flex: 1; padding: 12px; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; transition: 0.2s; }
    .btn:disabled { opacity: 0.6; cursor: not-allowed; }
    .btn-primary { background: #4472C4; color: white; }
    .btn-primary:hover { background: #365A99; }
    .btn-outline { background: transparent; border: 2px solid #ddd; color: #666; }
    .btn-outline:hover { border-color: #aaa; }

    .loading-overlay {
      position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(255,255,255,0.9); display: flex; justify-content: center; align-items: center;
      z-index: 1000; font-weight: bold; color: #4472C4;
    }

    @media (max-width: 768px) {
      .container { flex-direction: column; max-height: none; border-radius: 0; }
      body { padding: 0; }
      .main-content { flex-direction: column; }
      .panel-left, .panel-right { padding: 20px; border: none; }
      .service-grid { max-height: 200px; }
    }
  </style>
</head>
<body>

  <div id="loader" class="loading-overlay" style="display:none;">üîÑ Pobieranie bazy danych...</div>

  <div class="container">
    <div class="header">
      <h1>üõ†Ô∏è MarineLab Pro <small style="font-size:0.6em; opacity:0.8">v2.3</small></h1>
      <div class="status-badge" id="dbStatus">üì¶ Baza: Domy≈õlna</div>
    </div>

    <div class="main-content">
      <!-- LEFT PANEL -->
      <div class="panel-left">
        
        <div class="form-group">
          <label>Numer Zam√≥wienia (ZK)</label>
          <input type="text" id="invoiceName" placeholder="Wpisz numer ZK...">
        </div>

        <div class="form-group">
          <label>üë∑ Mechanik/Wykonawca zlecenia</label>
          <select id="mechanic" onchange="handleMechanicChange()">
            <option value="">-- Wybierz --</option>
          </select>
        </div>

        <div class="form-row">
          <div>
            <label>üí∞ Przych√≥d netto wg faktury</label>
            <input type="number" id="invoiceAmount" placeholder="0.00" oninput="updateResults()">
          </div>
          <div>
            <label>‚öôÔ∏è Czƒô≈õci zam. koszt netto</label>
            <input type="number" id="partsCost" placeholder="0.00" oninput="updateResults()">
          </div>
        </div>

        <div class="btn-group">
          <button class="btn btn-primary" id="sendBtn" onclick="sendToMake()" disabled>üöÄ Wy≈õlij</button>
          <button class="btn btn-outline" onclick="clearAll()">üóëÔ∏è Reset</button>
        </div>
        <p id="msg" style="text-align:center; margin-top:10px; font-size:12px; height:15px;"></p>
      </div>

      <!-- RIGHT PANEL -->
      <div class="panel-right">
        <label>Rodzaje wykonanych us≈Çug:</label>
        <div id="servicesGrid" class="service-grid">
          <div style="grid-column: 1/-1; text-align:center; color:#999; padding: 40px;">
            Najpierw wybierz wykonawcƒô üëà
          </div>
        </div>

        <!-- Custom Service Input -->
        <div class="manual-service-box" id="manualBox" style="display:none;">
          <label style="margin-bottom:5px; font-size:11px;">Dodaj niestandardowƒÖ us≈Çugƒô (Inne-3/Dojazd)</label>
          <div class="manual-row">
            <input type="text" id="customName" placeholder="Opis (np. Dojazd)" value="Inne-3">
            <input type="number" id="customPrice" placeholder="Kwota" style="width:100px;">
            <button class="manual-btn" onclick="addCustomService()">Dodaj</button>
          </div>
        </div>

        <label style="margin-top:20px;">Zrealizowane us≈Çugi:</label>
        <div id="servicesList" class="services-list"></div>

        <div class="results-card">
          <!-- REORDERED SECTION START -->
          <div class="result-row">
            <span>Przych√≥d netto wg faktury:</span> <strong id="invoiceTotalDisplay">0.00 z≈Ç</strong>
          </div>
          <div class="result-row">
            <span>Czƒô≈õci zam. koszt netto:</span> <strong id="partsCostDisplay">0.00 z≈Ç</strong>
          </div>
          <div class="result-row">
            <span>Robocizna koszt netto:</span> <strong id="laborCost">0.00 z≈Ç</strong>
          </div>
          <!-- REORDERED SECTION END -->

          <hr style="margin:10px 0; border:0; border-top:1px dashed #ddd;">
          
          <div class="result-row" style="font-size:13px; color:#007bff">
            <span>Dla Mechanika (<span id="mechPercent">100%</span>):</span> <strong id="mechSalaryDisplay">0.00 z≈Ç</strong>
          </div>
          
          <div class="total-profit" id="companyProfit">
            Wynik (Firma): 0.00 z≈Ç
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    // --- KONFIGURACJA ---
    const SEND_WEBHOOK_URL = 'https://hook.eu2.make.com/s3zw427rmr92hlo9sb4s9s8g4d6fsa42';
    const DB_WEBHOOK_URL = 'https://hook.eu2.make.com/as0emqranzdjwst67bvy37101wv5gp1s'; 

    const DEFAULT_PRICES = {
      "Marek": { "Roboczogodzina": 300, "1-cyl przeglƒÖd": 210, "Inne-1": 100 },
      "Waldek": { "1 godzina": 100, "Inne-1": 100 },
      "Jarek": { "1 godzina": 100, "Inne-1": 100 },
      "Jacek": { "1 godzina": 100, "Inne-1": 100 },
      "Roman": {}
    };

    let pricesDB = DEFAULT_PRICES;
    let selectedServices = [];

    window.onload = async function() {
      await fetchPrices();
      populateMechanics();
    };

    function handleMechanicChange() {
      loadServices();
    }

    async function fetchPrices() {
      if (!DB_WEBHOOK_URL || DB_WEBHOOK_URL.includes('TWOJ_KOD')) return; 
      document.getElementById('loader').style.display = 'flex';
      try {
        const response = await fetch(DB_WEBHOOK_URL);
        if (response.ok) {
          const rawData = await response.json();
          let newPricesDB = {};
          if (Array.isArray(rawData)) {
            rawData.forEach(row => {
              let mechName = row["Technik"] || row["A"] || row[0];
              let svcName = row["Service"] || row["B"] || row[1];
              let price = row["Price_Net"] || row["C"] || row[2];
              if (mechName && svcName) {
                if (!newPricesDB[mechName]) newPricesDB[mechName] = {};
                newPricesDB[mechName][svcName] = Number(price);
              }
            });
            Object.keys(newPricesDB).forEach(m => {
              if(!newPricesDB[m]["Inne-1"]) newPricesDB[m]["Inne-1"] = 100;
              if(!newPricesDB[m]["Inne-2"]) newPricesDB[m]["Inne-2"] = 200;
            });
          }
          if (Object.keys(newPricesDB).length > 0) {
            pricesDB = newPricesDB;
            document.getElementById('dbStatus').textContent = 'üü¢ Baza: Excel (Live)';
            document.getElementById('dbStatus').style.background = '#d4edda';
            document.getElementById('dbStatus').style.color = '#155724';
          }
        }
      } catch (e) { console.error("B≈ÇƒÖd bazy", e); } 
      finally { document.getElementById('loader').style.display = 'none'; }
    }

    function populateMechanics() {
      const select = document.getElementById('mechanic');
      select.innerHTML = '<option value="">-- Wybierz --</option>';
      Object.keys(pricesDB).forEach(mech => {
        let opt = document.createElement('option');
        opt.value = mech;
        opt.textContent = mech;
        select.appendChild(opt);
      });
    }

    function loadServices() {
      let mechanic = document.getElementById('mechanic').value;
      let grid = document.getElementById('servicesGrid');
      let manualBox = document.getElementById('manualBox');
      selectedServices = [];
      updateResults();
      if (!mechanic) {
        grid.innerHTML = '<div style="grid-column: 1/-1; text-align:center; color:#999; padding: 40px;">Najpierw wybierz wykonawcƒô üëà</div>';
        manualBox.style.display = 'none';
        return;
      }
      manualBox.style.display = 'block'; 
      const services = pricesDB[mechanic] || {};
      const keys = Object.keys(services);
      grid.innerHTML = keys.map(svc => `
        <div class="service-item" onclick="toggleService('${svc}')">
          <strong>${svc}</strong>
          <small style="color:#666; margin-top:5px;">${services[svc]} z≈Ç</small>
        </div>
      `).join('');
    }

    function toggleService(serviceName) {
      let mechanic = document.getElementById('mechanic').value;
      let cost = pricesDB[mechanic][serviceName];
      selectedServices.push({ name: serviceName, cost: cost });
      renderSelectedList();
      updateResults();
    }

    function addCustomService() {
      const name = document.getElementById('customName').value || "Inne-3";
      const price = parseFloat(document.getElementById('customPrice').value);
      if (!price || price <= 0) return alert("Wpisz poprawnƒÖ kwotƒô!");
      selectedServices.push({ name: name, cost: price });
      document.getElementById('customPrice').value = '';
      renderSelectedList();
      updateResults();
    }

    function renderSelectedList() {
      const list = document.getElementById('servicesList');
      list.innerHTML = selectedServices.map((item, index) => `
        <div class="service-tag">
          ${item.name} (${item.cost} z≈Ç)
          <span onclick="removeService(${index})">√ó</span>
        </div>
      `).join('');
    }

    function removeService(index) {
      selectedServices.splice(index, 1);
      renderSelectedList();
      updateResults();
    }

    function updateResults() {
      let mechanic = document.getElementById('mechanic').value;
      let invoiceAmount = parseFloat(document.getElementById('invoiceAmount').value) || 0;
      let partsCost = parseFloat(document.getElementById('partsCost').value) || 0;
      let laborCost = selectedServices.reduce((sum, item) => sum + item.cost, 0);

      let salaryMultiplier = (mechanic === 'Marek') ? 0.50 : 1.00;
      let mechanicSalary = laborCost * salaryMultiplier;
      let profit = invoiceAmount - partsCost - mechanicSalary;

      document.getElementById('laborCost').textContent = laborCost.toFixed(2) + ' z≈Ç';
      document.getElementById('mechPercent').textContent = (salaryMultiplier * 100) + '%';
      document.getElementById('mechSalaryDisplay').textContent = mechanicSalary.toFixed(2) + ' z≈Ç';
      document.getElementById('invoiceTotalDisplay').textContent = invoiceAmount.toFixed(2) + ' z≈Ç';
      document.getElementById('partsCostDisplay').textContent = partsCost.toFixed(2) + ' z≈Ç';
      
      const profitEl = document.getElementById('companyProfit');
      profitEl.textContent = 'Wynik (Firma): ' + profit.toFixed(2) + ' z≈Ç';
      profitEl.style.color = profit >= 0 ? '#28a745' : '#dc3545';

      const isValid = document.getElementById('invoiceName').value && 
                      document.getElementById('mechanic').value;
      document.getElementById('sendBtn').disabled = !isValid;
    }

    async function sendToMake() {
      const btn = document.getElementById('sendBtn');
      const msg = document.getElementById('msg');
      btn.disabled = true;
      btn.textContent = '‚è≥ Wysy≈Çanie...';

      let mechanic = document.getElementById('mechanic').value;
      let invoiceAmount = parseFloat(document.getElementById('invoiceAmount').value) || 0;
      let partsCost = parseFloat(document.getElementById('partsCost').value) || 0;
      let laborCost = selectedServices.reduce((sum, item) => sum + item.cost, 0);
      
      let salaryMultiplier = (mechanic === 'Marek') ? 0.50 : 1.00;
      let mechanicSalary = laborCost * salaryMultiplier;
      let profit = invoiceAmount - partsCost - mechanicSalary;

      const payload = {
        nr_zlecenia_opis: document.getElementById('invoiceName').value, 
        mechanik: mechanic,
        uslugi_lista: selectedServices.map(s => `${s.name} (${s.cost})`).join(', '),
        faktura_netto: invoiceAmount,
        czesci_netto: partsCost,
        robocizna_netto: laborCost,
        wynagrodzenie_mech: mechanicSalary, 
        wynik: profit, 
        timestamp: new Date().toISOString()
      };

      try {
        let res = await fetch(SEND_WEBHOOK_URL, {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify(payload)
        });
        
        if (res.ok) {
          msg.textContent = '‚úÖ Wys≈Çano pomy≈õlnie!';
          msg.style.color = 'green';
          setTimeout(clearAll, 1500);
        } else {
          throw new Error('B≈ÇƒÖd serwera');
        }
      } catch (e) {
        msg.textContent = '‚ùå B≈ÇƒÖd wysy≈Çania: ' + e.message;
        msg.style.color = 'red';
        btn.disabled = false;
        btn.textContent = 'üöÄ Wy≈õlij';
      }
    }

    function clearAll() {
      document.getElementById('invoiceName').value = '';
      document.getElementById('invoiceAmount').value = '';
      document.getElementById('partsCost').value = '';
      document.getElementById('mechanic').value = '';
      document.getElementById('msg').textContent = '';
      document.getElementById('sendBtn').textContent = 'üöÄ Wy≈õlij';
      document.getElementById('customPrice').value = '';
      selectedServices = [];
      loadServices(); 
      renderSelectedList();
    }
  </script>
</body>
</html>
